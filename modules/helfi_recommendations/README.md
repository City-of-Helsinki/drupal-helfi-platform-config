# Helfi annif integration

See also Confluence documentation (in Finnish): https://helsinkisolutionoffice.atlassian.net/wiki/x/AQCFSwI

Recommendation topics are generated for entities that include the `suggested_topics_reference` field. This is a custom
field extending the core entity reference field.

Since these topics are generated by a background task, they are stored in a separate entity to which the field points.
This approach ensures that the original entity remains unchanged when the background task is completed.

## Finto AI api

See the API documentation at: [https://ai.finto.fi/v1/ui/](https://ai.finto.fi/v1/ui/).

## Suggestions across hel.fi instances

### Elasticsearch index

Suggested topics entities are synced to `suggestions` search api index. The index is hosted with etusivu instance and all instances write and read to/from that shared index.

#### Clearing the index

Search index can be cleared manually or by certain configuration changes on deploy. Search API maintains a db registry for search index status but this registry will become out-of-date when the index is cleared by another instance. A mechanism to handle this will be implemented in UHF-12198, but until that we need to follow these guidelines:

* Clear index on all instances at the same time, to make sure none of the local registries have items that are actually missing from the index.
* Run indexing on all instances only after each of them has been cleared (this is challenged by the cron based indexing, which might trigger too early) 

### "Recommended for you"-block

All core instances have a "Recommended for you"-block enabled on Article, News, Standard Page and TPR Service content types. The block fetches content recommendations from the `suggestions` index, filtering results based on suggestion topics generated for current entity as well as editor managed settings for instances and content types.

#### Block visibility

Block visibility is controlled per entity ("Show automatically recommended content on this page"-field). This boolean field is enabled by default, but the default visibility can be changed per instance via a State API variable `helfi_recommendations.suggested_topics_default_show_block`:

```shell
drush sset helfi_recommendations.suggested_topics_default_show_block FALSE
```

## Text converter

The AI API accepts raw text only. Drupal content must be converted to UTF-8 encoded raw text. This is achieved with
`TextConverterManager`.

```php
$raw_text = \Drupal::service(\Drupal\helfi_platform_config\TextConverter\TextConverterManager::class)
  ->convert(MyEntity::load(123));
```

The generic implementation provided by this module checks if the given entity has `text_converter` view mode enabled.
If it is, the entity is rendered using that view mode and all HTML is stripped away.

Any irrelevant fields might degrade the suggestions, so it is important to configure the view mode to hide fields that
do not contribute to the main content of the entity.

If more customization is needed, implement custom `TextConverterInterface` for your own entities.

```php
<?php

declare(strict_types=1);

namespace Drupal\my_module\TextConverter;

/**
 * Coverts my entity to text.
 */
final class MyTextConverter implements TextConverterInterface {

  /**
   * {@inheritDoc}
   */
  public function applies(EntityInterface $entity): bool {
    return $entity instanceof MyEntity;
  }

  /**
   * {@inheritDoc}
   */
  public function convert(EntityInterface $entity): string {
    assert($entity instanceof MyEntity);
    return $entity->label() . "\n" . $entity->get('field_body')->value;
  }

}

```

Text converter output can be viewed with `drush helfi:recommendations:preview-text` command, see `--help` for options.
