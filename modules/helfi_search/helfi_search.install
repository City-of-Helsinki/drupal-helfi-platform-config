<?php

/**
 * @file
 * Install hooks for the helfi_search module.
 */

declare(strict_types=1);

use Drupal\search_api\Entity\Index;

/**
 * Implements hook_schema().
 */
function helfi_search_schema(): array {
  $schema = [];

  $schema['helfi_search_token_usage'] = [
    'description' => 'Tracks token usage for OpenAI models.',
    'fields' => [
      'model_name' => [
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'description' => 'The model name.',
      ],
      'total_tokens' => [
        'type' => 'int',
        'size' => 'big',
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Total tokens consumed by this model.',
      ],
    ],
    'primary key' => ['model_name'],
  ];

  return $schema;
}

/**
 * Implements hook_install().
 */
function helfi_search_install($is_syncing) : void {
  // Do not perform following steps if the module is being installed as part
  // of a configuration import.
  if ($is_syncing) {
    return;
  }

  // Enable etusivu search_api server.
  $config_factory = \Drupal::configFactory();
  $etusivu_server_settings = $config_factory->getEditable('search_api.server.etusivu');
  if ($etusivu_server_settings->get('status') === FALSE) {
    $etusivu_server_settings
      ->set('status', TRUE)
      ->save();
  }
}

/**
 * Update the embeddings index datasources and enable multisite option.
 */
function helfi_search_update_8001() {
  $config = \Drupal::configFactory()->getEditable('search_api.index.embeddings');

  // Do not run the update if the config didn't exist yet.
  if ($config->isNew()) {
    return;
  }

  // Change all uuid-datasources to regular entity datasources.
  $datasource_settings = $config->get('datasource_settings');
  foreach ($datasource_settings as $datasource_id => $datasource_setting_value) {
    if (str_starts_with($datasource_id, 'uuid_entity:')) {
      $new_datasource_id = str_replace('uuid_entity:', 'entity:', $datasource_id);
      $datasource_settings[$new_datasource_id] = $datasource_setting_value;
      unset($datasource_settings[$datasource_id]);
    }
  }
  $config->set('datasource_settings', $datasource_settings);

  // Enable multisite option.
  $options = $config->get('options');
  $options['helfi_platform_config_multisite'] = TRUE;
  $config->set('options', $options);

  $config->save();
}

/**
 * Update embeddings index fields.
 */
function helfi_search_update_8002() {
  $config = \Drupal::configFactory()->getEditable('search_api.index.embeddings');

  // Do not run the update if the config didn't exist yet.
  if ($config->isNew()) {
    return;
  }

  // Update fields that are still trying to use the old uuid_entity datasource.
  $field_settings = $config->get('field_settings');
  foreach ($field_settings as $field_id => $field_value) {
    if (isset($field_value['datasource_id']) && str_starts_with($field_value['datasource_id'], 'uuid_entity:')) {
      $field_settings[$field_id]['datasource_id'] = str_replace('uuid_entity:', 'entity:', $field_value['datasource_id']);
    }
  }
  $config->set('field_settings', $field_settings);

  $config->save();
}

/**
 * Add new processors and TPR datasources to the embeddings index.
 */
function helfi_search_update_11000(): void {
  $index = Index::load('embeddings');

  if (!$index) {
    return;
  }

  $moduleHandler = \Drupal::moduleHandler();
  /** @var \Drupal\search_api\Utility\PluginHelperInterface $pluginHelper */
  $pluginHelper = \Drupal::service('search_api.plugin_helper');

  // Add TPR datasources if helfi_tpr module is installed.
  if ($moduleHandler->moduleExists('helfi_tpr')) {
    $tpr_datasources = ['entity:tpr_service', 'entity:tpr_unit'];

    foreach ($tpr_datasources as $datasource_id) {
      if (!$index->isValidDatasource($datasource_id)) {
        $datasource = $pluginHelper->createDatasourcePlugin($index, $datasource_id);
        $index->addDatasource($datasource);
      }
    }
  }

  $index->save();
}

/**
 * Replace node-specific title field with entity label processor field.
 */
function helfi_search_update_11001(): void {
  $index = Index::load('embeddings');

  if (!$index) {
    return;
  }

  // Remove the old node-specific title field.
  if ($index->getField('title')) {
    $index->removeField('title');
  }

  // Add the entity label field backed by the new processor.
  if (!$index->getField('label')) {
    /** @var \Drupal\search_api\Utility\PluginHelperInterface $pluginHelper */
    $pluginHelper = \Drupal::service('search_api.plugin_helper');

    // Enable the helfi_entity_label processor.
    if (!$index->isValidProcessor('helfi_entity_label')) {
      $processor = $pluginHelper->createProcessorPlugin($index, 'helfi_entity_label');
      $index->addProcessor($processor);
    }

    $field = \Drupal::getContainer()
      ->get('search_api.fields_helper')
      ->createField($index, 'label', [
        'label' => 'Entity label',
        'property_path' => 'helfi_entity_label',
        'type' => 'string',
      ]);
    $index->addField($field);
  }

  $index->save();
}

/**
 * Decrease embeddings index batch size per cron run.
 */
function helfi_search_update_11002(): void {
  $index = Index::load('embeddings');

  if (!$index) {
    return;
  }

  $index->setOption('cron_limit', 1);
  $index->save();
}
