<?php

/**
 * @file
 * Contains 'helfi_ckeditor' hooks.
 */

declare(strict_types=1);

use Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition;
use Drupal\Core\Language\LanguageInterface;

/**
 * Modify the list of available CKEditor 5 plugins.
 *
 * @param array $plugin_definitions
 *   An array of all the existing plugin definitions, passed by reference.
 *
 * @see \Drupal\ckeditor5\Plugin\CKEditor5PluginManager
 */
function helfi_ckeditor_ckeditor5_plugin_info_alter(array &$plugin_definitions): void {
  /** @var Drupal\ckeditor5\Plugin\CKEditor5PluginDefinition $table_plugin_definition */
  $table_plugin_definition = $plugin_definitions['ckeditor5_table'];
  $original_table_plugin = $table_plugin_definition->toArray();

  // Unset the 'table.PlainTableOutput' CKEditor5 plugin as we want to preserve
  // the <figure class="table"> > <figcaption> functionality.
  if (($plugin = array_search('table.PlainTableOutput', $original_table_plugin['ckeditor5']['plugins'])) !== FALSE) {
    unset($original_table_plugin['ckeditor5']['plugins'][$plugin]);
  }

  // Save ckeditor5_table plugin definitions.
  $plugin_definitions['ckeditor5_table'] = new CKEditor5PluginDefinition($original_table_plugin);
}

/**
 * Implements hook_js_settings_alter().
 */
function helfi_ckeditor_js_settings_alter(array &$settings) {
  // Ckeditor uses UI language to decide whether to use LTR or RTL direction on editor.
  // Overwrite the UI langcode with content langcode to instantiate the ckeditor with correct direction.
  $content_language = \Drupal::languageManager()->getCurrentLanguage(LanguageInterface::TYPE_CONTENT);
  $language_id = $content_language->getId();
  if (isset($settings['editor']['formats']['full_html'])) {
    $settings['editor']['formats']['full_html']['editorSettings']['language']['ui'] = $language_id;
  }
  if (isset($settings['editor']['formats']['simple_html'])) {
    $settings['editor']['formats']['simple_html']['editorSettings']['language']['ui'] = $language_id;
  }
  if (isset($settings['editor']['formats']['minimal'])) {
    $settings['editor']['formats']['minimal']['editorSettings']['language']['ui'] = $language_id;
  }
}
