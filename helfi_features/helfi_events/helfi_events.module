<?php

use Drupal\helfi_events\LinkedEvents;

/**
 * Implements hook_preprocess_paragraph().
 */
function helfi_events_preprocess_paragraph__event_list(&$variables) {
  // Expose event list variables to frontend
  if(isset($variables['paragraph'])) {
    $paragraph = $variables['paragraph'];
    $linkedEvents = Drupal::service('helfi_events_linked_events');
    
    if (!$paragraph->get('field_api_url')->isEmpty()) {
      $intialUrl = $paragraph->get('field_api_url')->first()->getUrl()->toString();
      $params = $linkedEvents->parseParams($intialUrl);
      $variables['#attached']['drupalSettings']['helfi_events']['eventsUrl'] = $linkedEvents->getEventsRequest($params);
      $variables['#attached']['drupalSettings']['helfi_events']['initialUrl'] = $intialUrl;
    }

    if ($loadMore = $paragraph->get('field_load_more')->getValue()) {
      $variables['#attached']['drupalSettings']['helfi_events']['loadMore'] = $loadMore;
    }
  }
  
  $variables['#attached']['library'][] = 'helfi_events/events_list';
  $variables['#attached']['drupalSettings']['helfi_events']['baseUrl'] = LinkedEvents::BASE_URL;
}
