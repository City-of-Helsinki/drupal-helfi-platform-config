<?php

/**
 * @file
 * Contains HELfi platform configuration alterations.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Render\BubbleableMetadata;
use Symfony\Component\Yaml\Parser;

/**
 * Implements hook_ENTITY_TYPE_view_alter().
 */
function helfi_platform_config_node_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  // Replace node title on nodes with the visible title field.
  // @todo Needs work on caches, wrong title is displayed if user visits content listing.
  if ($entity->hasField('field_unit_visible_title')) {
    $entity->set('title', \Drupal::token()->replace((string) $entity->get('field_unit_visible_title')->value));
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function helfi_platform_config_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'modules_installed') {
    $moduleHandler = \Drupal::service('module_handler');
    if ($moduleHandler->moduleExists('locale')) {
      unset($implementations['locale']);
    }
  }
}

/**
 * Implements hook_modules_installed().
 */
function helfi_platform_config_modules_installed() {
  $moduleHandler = \Drupal::service('module_handler');
  if ($moduleHandler->moduleExists('locale')) {
    locale_system_set_config_langcodes();
  }
}

/**
 * Implements hook_theme().
 */
function helfi_platform_config_theme() {
  return [
    'react_and_share' => [
      'variables' => [
        'title' => NULL,
        'content' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_token_info()
 */
function hdbt_content_token_info() {
  $info['tokens']['site']['page-title-suffix'] = [
    'name' => t('Page title suffix'),
    'description' => t('Official suffix for page title.'),
  ];
  return $info;
}

/**
 * Implements hook_tokens()
 */
function hdbt_content_tokens(
  $type,
  $tokens,
  array $data,
  array $options,
  BubbleableMetadata $bubbleable_metadata
) {
  $replacements = [];

  foreach ($tokens as $name => $original) {
    if ($name === 'page-title-suffix') {
      $language = Drupal::languageManager()->getCurrentLanguage();

      switch ($language->getId()) {
        case 'fi':
          $replacements[$original] = 'Helsingin kaupunki';
          break;
        case 'sv':
          $replacements[$original] = 'Helsingfors stad';
          break;
        case 'ru':
          $replacements[$original] = 'Гopoд Xeльcинки';
          break;
        default:
          $replacements[$original] = 'City of Helsinki';
          break;
      }
    }
  }

  return $replacements;
}

/**
 * Helper function to manually import translations.
 *
 * @param bool|string $module
 *   Module from where translations should be installed from.
 */
function _helfi_import_translations($module = FALSE) {

  if (!$module) {
    return;
  }

  $language_manager = Drupal::languageManager();
  $yaml_parser = new Parser();

  // The language code of the default locale.
  $site_default_langcode = $language_manager->getDefaultLanguage()->getId();

  // The directory where the language config files reside.
  $language_config_directory = __DIR__ . "/helfi_features/{$module}/config/install/language";

  // Check if feature has translated config files.
  if (!is_dir($language_config_directory)) {
    return;
  }

  // Scan the translations directory.
  $language_directory = scandir($language_config_directory);
  $skip_dirs = ['..', '.', $site_default_langcode];

  // Sub-directory names (language codes).
  // The language code of the default language is excluded.
  $langcodes = array_diff($language_directory, $skip_dirs);

  foreach ($langcodes as $langcode) {
    // All .yml files in the language's config subdirectory.
    $config_files = glob("$language_config_directory/$langcode/*.yml");

    foreach ($config_files as $file_name) {
      // Information from the .yml file as an array.
      $yaml = $yaml_parser->parse(file_get_contents($file_name));
      // Uses the base name of the .yml file to get the config name.
      $config_name = basename($file_name, '.yml');
      // The language configuration object.
      $config = $language_manager->getLanguageConfigOverride($langcode, $config_name);

      foreach ($yaml as $config_key => $config_value) {
        // Update the configuration object.
        $config->set($config_key, $config_value);
      }
      $config->save(TRUE);
    }
  }
}
